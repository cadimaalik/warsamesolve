<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Junction Head Calculator - Three Reservoirs</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700&family=Spectral:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #4ade80;
            --primary-light: #86efac;
            --accent: #fbbf24;
            --bg: #0a0a0a;
            --surface: #171717;
            --text: #e5e5e5;
            --text-muted: #a3a3a3;
            --border: #404040;
            --error: #ef4444;
            --success: #22c55e;
            --grid: 8px;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Spectral', serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
        }
        
        .app-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: calc(var(--grid) * 6);
        }
        
        header {
            border-bottom: 3px solid var(--primary);
            padding-bottom: calc(var(--grid) * 3);
            margin-bottom: calc(var(--grid) * 6);
        }
        
        .back-link {
            display: inline-block;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.875rem;
            color: var(--text-muted);
            text-decoration: none;
            margin-bottom: calc(var(--grid) * 2);
            transition: color 0.2s;
        }
        
        .back-link:hover {
            color: var(--primary);
        }
        
        h1 {
            font-family: 'JetBrains Mono', monospace;
            font-size: 3rem;
            font-weight: 700;
            color: var(--primary);
            letter-spacing: -0.02em;
            margin-bottom: calc(var(--grid) * 1);
        }
        
        .subtitle {
            font-size: 1.125rem;
            color: var(--text-muted);
            font-weight: 400;
        }
        
        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1.5fr;
            gap: calc(var(--grid) * 4);
            align-items: start;
        }
        
        .input-panel {
            background: var(--surface);
            border: 2px solid var(--border);
            border-radius: 4px;
            padding: calc(var(--grid) * 4);
            position: sticky;
            top: calc(var(--grid) * 3);
            max-height: calc(100vh - calc(var(--grid) * 6));
            overflow-y: auto;
        }
        
        .results-panel {
            background: var(--surface);
            border: 2px solid var(--border);
            border-radius: 4px;
            padding: calc(var(--grid) * 4);
        }
        
        .panel-title {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--primary);
            margin-bottom: calc(var(--grid) * 3);
            padding-bottom: calc(var(--grid) * 2);
            border-bottom: 1px solid var(--border);
        }
        
        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: calc(var(--grid) * 3);
            padding-bottom: calc(var(--grid) * 2);
            border-bottom: 1px solid var(--border);
        }
        
        .form-section {
            margin-bottom: calc(var(--grid) * 4);
        }
        
        .section-label {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.875rem;
            color: var(--accent);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: calc(var(--grid) * 2);
        }
        
        .input-group {
            margin-bottom: calc(var(--grid) * 2);
        }
        
        label {
            display: block;
            font-size: 0.875rem;
            color: var(--text-muted);
            margin-bottom: calc(var(--grid) * 1);
        }
        
        input, select {
            width: 100%;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 2px;
            padding: calc(var(--grid) * 1.5);
            color: var(--text);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.875rem;
            transition: border-color 0.2s;
        }
        
        input::placeholder {
            color: var(--border);
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: var(--primary);
        }
        
        .calculate-button {
            width: 100%;
            background: var(--primary);
            color: var(--bg);
            border: none;
            border-radius: 4px;
            padding: calc(var(--grid) * 2);
            font-family: 'JetBrains Mono', monospace;
            font-size: 1rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            cursor: pointer;
            transition: background 0.2s;
            margin-top: calc(var(--grid) * 3);
        }
        
        .calculate-button:hover:not(:disabled) {
            background: var(--primary-light);
        }
        
        .calculate-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .load-example-button {
            background: transparent;
            color: var(--accent);
            border: 1px solid var(--accent);
            border-radius: 4px;
            padding: calc(var(--grid) * 1) calc(var(--grid) * 2);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .load-example-button:hover {
            background: var(--accent);
            color: var(--bg);
        }
        
        .result-card {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: calc(var(--grid) * 3);
            margin-bottom: calc(var(--grid) * 3);
        }
        
        .result-card.success {
            border-color: var(--success);
        }
        
        .result-card.error {
            border-color: var(--error);
        }
        
        .result-header {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--success);
            margin-bottom: calc(var(--grid) * 2);
        }
        
        .result-header.error {
            color: var(--error);
        }
        
        .result-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: calc(var(--grid) * 1);
        }
        
        .result-label {
            font-size: 0.875rem;
            color: var(--text-muted);
        }
        
        .pipe-result {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: calc(var(--grid) * 3);
            margin-bottom: calc(var(--grid) * 2);
        }
        
        .pipe-header {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--primary);
            margin-bottom: calc(var(--grid) * 2);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .flow-direction {
            font-size: 0.875rem;
            padding: calc(var(--grid) * 0.5) calc(var(--grid) * 1.5);
            border-radius: 2px;
            font-weight: 600;
        }
        
        .flow-direction.inflow {
            background: rgba(74, 222, 128, 0.1);
            color: var(--primary);
        }
        
        .flow-direction.outflow {
            background: rgba(251, 191, 36, 0.1);
            color: var(--accent);
        }
        
        .result-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: calc(var(--grid) * 2);
        }
        
        .result-item {
            display: flex;
            flex-direction: column;
        }
        
        .result-item-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: calc(var(--grid) * 0.5);
        }
        
        .result-item-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1rem;
            color: var(--text);
        }
        
        .convergence-info {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: calc(var(--grid) * 3);
            margin-top: calc(var(--grid) * 3);
        }
        
        .convergence-header {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1rem;
            font-weight: 600;
            color: var(--primary);
            margin-bottom: calc(var(--grid) * 2);
        }
        
        .iteration-section {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: calc(var(--grid) * 3);
            margin-bottom: calc(var(--grid) * 3);
        }
        
        .iteration-header {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--accent);
            margin-bottom: calc(var(--grid) * 2);
            padding-bottom: calc(var(--grid) * 2);
            border-bottom: 1px solid var(--border);
        }
        
        .iteration-step {
            margin-bottom: calc(var(--grid) * 3);
        }
        
        .step-title {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1rem;
            font-weight: 600;
            color: var(--primary);
            margin-bottom: calc(var(--grid) * 1);
        }
        
        .math-block {
            background: var(--surface);
            border-left: 3px solid var(--primary);
            padding: calc(var(--grid) * 2);
            margin: calc(var(--grid) * 2) 0;
            overflow-x: auto;
        }
        
        .iteration-table {
            width: 100%;
            border-collapse: collapse;
            margin: calc(var(--grid) * 2) 0;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.875rem;
        }
        
        .iteration-table th {
            background: var(--surface);
            color: var(--primary);
            padding: calc(var(--grid) * 1);
            text-align: left;
            border: 1px solid var(--border);
        }
        
        .iteration-table td {
            padding: calc(var(--grid) * 1);
            border: 1px solid var(--border);
        }
        
        .iteration-table tr:hover {
            background: var(--surface);
        }
        
        .reasoning {
            background: rgba(251, 191, 36, 0.1);
            border-left: 3px solid var(--accent);
            padding: calc(var(--grid) * 2);
            margin: calc(var(--grid) * 2) 0;
            font-style: italic;
            color: var(--text-muted);
        }
        
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--bg);
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary);
        }
        
        @media (max-width: 1024px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
            
            .input-panel {
                position: static;
                max-height: none;
            }
        }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        
        function JunctionHeadCalculator() {
            const [inputs, setInputs] = useState({
                z1: '',
                z2: '',
                z3: '',
                L1: '',
                L2: '',
                L3: '',
                D1: '',
                D2: '',
                D3: '',
                epsilon1: '',
                epsilon2: '',
                epsilon3: '',
                nu: '1.02e-6',
                tolerance: '1.0'
            });
            
            const [results, setResults] = useState(null);
            const [calculating, setCalculating] = useState(false);
            const [iterationDetails, setIterationDetails] = useState([]);
            
            // Refs for Enter key navigation
            const inputRefs = useRef({});
            
            // Field order for Enter key navigation
            const fieldOrder = [
                'z1', 'z2', 'z3',
                'L1', 'D1', 'epsilon1',
                'L2', 'D2', 'epsilon2',
                'L3', 'D3', 'epsilon3',
                'nu', 'tolerance'
            ];
            
            useEffect(() => {
                if ((results || iterationDetails.length > 0) && window.MathJax) {
                    window.MathJax.typesetPromise();
                }
            }, [results, iterationDetails]);
            
            const handleInputChange = (field, value) => {
                setInputs(prev => ({
                    ...prev,
                    [field]: value
                }));
            };
            
            const handleKeyPress = (e, currentField) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    const currentIndex = fieldOrder.indexOf(currentField);
                    if (currentIndex < fieldOrder.length - 1) {
                        const nextField = fieldOrder[currentIndex + 1];
                        if (inputRefs.current[nextField]) {
                            inputRefs.current[nextField].focus();
                        }
                    } else {
                        // Last field, trigger calculate
                        calculate();
                    }
                }
            };
            
            const loadExample = () => {
                setInputs({
                    z1: '20',
                    z2: '100',
                    z3: '40',
                    L1: '100',
                    L2: '150',
                    L3: '80',
                    D1: '0.08',
                    D2: '0.06',
                    D3: '0.04',
                    epsilon1: '0.00024',
                    epsilon2: '0.00012',
                    epsilon3: '0.00020',
                    nu: '1.02e-6',
                    tolerance: '1.0'
                });
                setResults(null);
                setIterationDetails([]);
            };
            
            const swameeJain = (Re, eOverD) => {
                if (Re < 4000) return 64 / Re;
                const term = eOverD / 3.7 + 5.74 / Math.pow(Re, 0.9);
                return 1.325 / Math.pow(Math.log(term), 2);
            };
            
            const calculatePipeFlow = (z_res, Hj, L, D, epsilon, nu, pipeNum) => {
                const g = 9.81;
                const deltaH = z_res - Hj;
                
                if (Math.abs(deltaH) < 0.001) {
                    return { 
                        Q: 0, V: 0, Re: 0, f: 0, hf: 0,
                        iterations: []
                    };
                }
                
                const eOverD = epsilon / D;
                
                // Initial f from hydraulically rough assumption
                let f = 1.325 / Math.pow(Math.log(eOverD / 3.7), 2);
                
                const fIterations = [];
                let V, Q, Re, fNew;
                
                for (let i = 0; i < 20; i++) {
                    V = Math.sqrt((2 * g * Math.abs(deltaH) * D) / (f * L));
                    const A = Math.PI * Math.pow(D, 2) / 4;
                    Q = V * A;
                    Re = (V * D) / nu;
                    fNew = swameeJain(Re, eOverD);
                    
                    fIterations.push({
                        iteration: i + 1,
                        f: f,
                        V: V,
                        Re: Re,
                        eOverD: eOverD,
                        fNew: fNew
                    });
                    
                    if (Math.abs(fNew - f) < 0.0001) break;
                    f = fNew;
                }
                
                const Qsigned = deltaH > 0 ? Q : -Q;
                
                return {
                    Q: Qsigned,
                    V: V,
                    Re: Re,
                    f: fNew,
                    hf: Math.abs(deltaH),
                    deltaH: deltaH,
                    iterations: fIterations
                };
            };
            
            const calculate = () => {
                setCalculating(true);
                setIterationDetails([]);
                
                try {
                    const z1 = parseFloat(inputs.z1);
                    const z2 = parseFloat(inputs.z2);
                    const z3 = parseFloat(inputs.z3);
                    const L1 = parseFloat(inputs.L1);
                    const L2 = parseFloat(inputs.L2);
                    const L3 = parseFloat(inputs.L3);
                    const D1 = parseFloat(inputs.D1);
                    const D2 = parseFloat(inputs.D2);
                    const D3 = parseFloat(inputs.D3);
                    const epsilon1 = parseFloat(inputs.epsilon1);
                    const epsilon2 = parseFloat(inputs.epsilon2);
                    const epsilon3 = parseFloat(inputs.epsilon3);
                    const nu = parseFloat(inputs.nu);
                    const tolerance = parseFloat(inputs.tolerance);
                    
                    // Validate inputs
                    if ([z1, z2, z3, L1, L2, L3, D1, D2, D3, epsilon1, epsilon2, epsilon3, nu, tolerance].some(v => isNaN(v))) {
                        throw new Error('Please fill in all fields with valid numbers');
                    }
                    
                    // Sort elevations
                    const elevations = [z1, z2, z3].sort((a, b) => a - b);
                    const zLow = elevations[0];
                    const zMid = elevations[1];
                    const zHigh = elevations[2];
                    
                    // Initial guess
                    let Hj = zMid;
                    const iterDetails = [];
                    const history = [];
                    let converged = false;
                    let iteration = 0;
                    const maxIterations = 50;
                    
                    let pipe1, pipe2, pipe3, sumQ, totalInflow, errorPercent;
                    
                    while (iteration < maxIterations) {
                        iteration++;
                        
                        const iterDetail = {
                            iteration: iteration,
                            Hj: Hj,
                            reasoning: ''
                        };
                        
                        // Reasoning for Hj choice
                        if (iteration === 1) {
                            iterDetail.reasoning = `Initial assumption: H_j = z_{middle} = ${zMid} m (middle reservoir elevation). This ensures Pipe ${[z1, z2, z3].indexOf(zMid) + 1} initially has zero flow, making the other two pipes' directions clear.`;
                        } else if (iteration === 2) {
                            const prevSumQ = history[0].sumQ;
                            if (prevSumQ > 0) {
                                iterDetail.reasoning = `Previous iteration: ΣQ = ${(prevSumQ * 3600).toFixed(1)} m³/hr > 0 (influx > outflux). Junction head too low. Adjust H_j upward to (${history[0].Hj} + ${zHigh})/2 = ${Hj.toFixed(2)} m.`;
                            } else {
                                iterDetail.reasoning = `Previous iteration: ΣQ = ${(prevSumQ * 3600).toFixed(1)} m³/hr < 0 (outflux > influx). Junction head too high. Adjust H_j downward to (${zLow} + ${history[0].Hj})/2 = ${Hj.toFixed(2)} m.`;
                            }
                        } else {
                            const Hj1 = history[history.length - 2].Hj;
                            const sumQ1 = history[history.length - 2].sumQ;
                            const Hj2 = history[history.length - 1].Hj;
                            const sumQ2 = history[history.length - 1].sumQ;
                            iterDetail.reasoning = `Linear interpolation: Two points (${Hj1.toFixed(2)}, ${(sumQ1 * 3600).toFixed(1)}) and (${Hj2.toFixed(2)}, ${(sumQ2 * 3600).toFixed(1)}). Find H_j where ΣQ = 0: H_j = ${Hj1.toFixed(2)} + (${Hj2.toFixed(2)} - ${Hj1.toFixed(2)}) × (0 - ${(sumQ1 * 3600).toFixed(1)})/(${(sumQ2 * 3600).toFixed(1)} - ${(sumQ1 * 3600).toFixed(1)}) = ${Hj.toFixed(2)} m`;
                        }
                        
                        // Calculate Q for each pipe
                        pipe1 = calculatePipeFlow(z1, Hj, L1, D1, epsilon1, nu, 1);
                        pipe2 = calculatePipeFlow(z2, Hj, L2, D2, epsilon2, nu, 2);
                        pipe3 = calculatePipeFlow(z3, Hj, L3, D3, epsilon3, nu, 3);
                        
                        iterDetail.pipe1 = pipe1;
                        iterDetail.pipe2 = pipe2;
                        iterDetail.pipe3 = pipe3;
                        
                        // Check continuity
                        sumQ = pipe1.Q + pipe2.Q + pipe3.Q;
                        totalInflow = Math.max(
                            (pipe1.Q > 0 ? pipe1.Q : 0) +
                            (pipe2.Q > 0 ? pipe2.Q : 0) +
                            (pipe3.Q > 0 ? pipe3.Q : 0),
                            0.0001
                        );
                        errorPercent = Math.abs(sumQ / totalInflow) * 100;
                        
                        iterDetail.sumQ = sumQ;
                        iterDetail.totalInflow = totalInflow;
                        iterDetail.errorPercent = errorPercent;
                        
                        iterDetails.push(iterDetail);
                        
                        // Check convergence
                        if (errorPercent < tolerance) {
                            converged = true;
                            break;
                        }
                        
                        // Store data point
                        history.push({ Hj, sumQ });
                        
                        // Update Hj
                        if (iteration === 1) {
                            if (sumQ > 0) {
                                Hj = (Hj + zHigh) / 2;
                            } else {
                                Hj = (zLow + Hj) / 2;
                            }
                        } else {
                            const Hj1 = history[history.length - 2].Hj;
                            const sumQ1 = history[history.length - 2].sumQ;
                            const Hj2 = history[history.length - 1].Hj;
                            const sumQ2 = history[history.length - 1].sumQ;
                            
                            Hj = Hj1 + (Hj2 - Hj1) * (0 - sumQ1) / (sumQ2 - sumQ1);
                            Hj = Math.max(zLow, Math.min(zHigh, Hj));
                        }
                    }
                    
                    if (!converged) {
                        setResults({
                            error: true,
                            message: `Did not converge after ${maxIterations} iterations`
                        });
                        setIterationDetails(iterDetails);
                        return;
                    }
                    
                    setIterationDetails(iterDetails);
                    setResults({
                        success: true,
                        Hj: Hj,
                        iterations: iteration,
                        errorPercent: errorPercent,
                        sumQ: sumQ,
                        totalInflow: totalInflow,
                        pipe1: {
                            ...pipe1,
                            z: z1,
                            L: L1,
                            D: D1,
                            epsilon: epsilon1
                        },
                        pipe2: {
                            ...pipe2,
                            z: z2,
                            L: L2,
                            D: D2,
                            epsilon: epsilon2
                        },
                        pipe3: {
                            ...pipe3,
                            z: z3,
                            L: L3,
                            D: D3,
                            epsilon: epsilon3
                        }
                    });
                } catch (error) {
                    setResults({
                        error: true,
                        message: error.message
                    });
                } finally {
                    setCalculating(false);
                }
            };
            
            return (
                <div className="app-container">
                    <header>
                        <a href="index.html" className="back-link">← Back to HydroSolve Hub</a>
                        <h1>Junction Head</h1>
                        <div className="subtitle">Three Reservoirs Connected at a Junction - Type II Problem</div>
                    </header>
                    
                    <div className="main-grid">
                        <div className="input-panel">
                            <div className="panel-header">
                                <div className="panel-title">Input Parameters</div>
                                <button className="load-example-button" onClick={loadExample}>
                                    Load Example 2.10
                                </button>
                            </div>
                            
                            <div className="form-section">
                                <div className="section-label">Reservoir Elevations</div>
                                <div className="input-group">
                                    <label>Reservoir 1 Elevation (z₁) [m]</label>
                                    <input
                                        ref={el => inputRefs.current['z1'] = el}
                                        type="number"
                                        step="any"
                                        value={inputs.z1}
                                        onChange={(e) => handleInputChange('z1', e.target.value)}
                                        onKeyPress={(e) => handleKeyPress(e, 'z1')}
                                        placeholder="e.g., 20"
                                    />
                                </div>
                                <div className="input-group">
                                    <label>Reservoir 2 Elevation (z₂) [m]</label>
                                    <input
                                        ref={el => inputRefs.current['z2'] = el}
                                        type="number"
                                        step="any"
                                        value={inputs.z2}
                                        onChange={(e) => handleInputChange('z2', e.target.value)}
                                        onKeyPress={(e) => handleKeyPress(e, 'z2')}
                                        placeholder="e.g., 100"
                                    />
                                </div>
                                <div className="input-group">
                                    <label>Reservoir 3 Elevation (z₃) [m]</label>
                                    <input
                                        ref={el => inputRefs.current['z3'] = el}
                                        type="number"
                                        step="any"
                                        value={inputs.z3}
                                        onChange={(e) => handleInputChange('z3', e.target.value)}
                                        onKeyPress={(e) => handleKeyPress(e, 'z3')}
                                        placeholder="e.g., 40"
                                    />
                                </div>
                            </div>
                            
                            <div className="form-section">
                                <div className="section-label">Pipe 1 Properties</div>
                                <div className="input-group">
                                    <label>Length (L₁) [m]</label>
                                    <input
                                        ref={el => inputRefs.current['L1'] = el}
                                        type="number"
                                        step="any"
                                        value={inputs.L1}
                                        onChange={(e) => handleInputChange('L1', e.target.value)}
                                        onKeyPress={(e) => handleKeyPress(e, 'L1')}
                                        placeholder="e.g., 100"
                                    />
                                </div>
                                <div className="input-group">
                                    <label>Diameter (D₁) [m]</label>
                                    <input
                                        ref={el => inputRefs.current['D1'] = el}
                                        type="number"
                                        step="any"
                                        value={inputs.D1}
                                        onChange={(e) => handleInputChange('D1', e.target.value)}
                                        onKeyPress={(e) => handleKeyPress(e, 'D1')}
                                        placeholder="e.g., 0.08"
                                    />
                                </div>
                                <div className="input-group">
                                    <label>Roughness (ε₁) [m]</label>
                                    <input
                                        ref={el => inputRefs.current['epsilon1'] = el}
                                        type="number"
                                        step="any"
                                        value={inputs.epsilon1}
                                        onChange={(e) => handleInputChange('epsilon1', e.target.value)}
                                        onKeyPress={(e) => handleKeyPress(e, 'epsilon1')}
                                        placeholder="e.g., 0.00024"
                                    />
                                </div>
                            </div>
                            
                            <div className="form-section">
                                <div className="section-label">Pipe 2 Properties</div>
                                <div className="input-group">
                                    <label>Length (L₂) [m]</label>
                                    <input
                                        ref={el => inputRefs.current['L2'] = el}
                                        type="number"
                                        step="any"
                                        value={inputs.L2}
                                        onChange={(e) => handleInputChange('L2', e.target.value)}
                                        onKeyPress={(e) => handleKeyPress(e, 'L2')}
                                        placeholder="e.g., 150"
                                    />
                                </div>
                                <div className="input-group">
                                    <label>Diameter (D₂) [m]</label>
                                    <input
                                        ref={el => inputRefs.current['D2'] = el}
                                        type="number"
                                        step="any"
                                        value={inputs.D2}
                                        onChange={(e) => handleInputChange('D2', e.target.value)}
                                        onKeyPress={(e) => handleKeyPress(e, 'D2')}
                                        placeholder="e.g., 0.06"
                                    />
                                </div>
                                <div className="input-group">
                                    <label>Roughness (ε₂) [m]</label>
                                    <input
                                        ref={el => inputRefs.current['epsilon2'] = el}
                                        type="number"
                                        step="any"
                                        value={inputs.epsilon2}
                                        onChange={(e) => handleInputChange('epsilon2', e.target.value)}
                                        onKeyPress={(e) => handleKeyPress(e, 'epsilon2')}
                                        placeholder="e.g., 0.00012"
                                    />
                                </div>
                            </div>
                            
                            <div className="form-section">
                                <div className="section-label">Pipe 3 Properties</div>
                                <div className="input-group">
                                    <label>Length (L₃) [m]</label>
                                    <input
                                        ref={el => inputRefs.current['L3'] = el}
                                        type="number"
                                        step="any"
                                        value={inputs.L3}
                                        onChange={(e) => handleInputChange('L3', e.target.value)}
                                        onKeyPress={(e) => handleKeyPress(e, 'L3')}
                                        placeholder="e.g., 80"
                                    />
                                </div>
                                <div className="input-group">
                                    <label>Diameter (D₃) [m]</label>
                                    <input
                                        ref={el => inputRefs.current['D3'] = el}
                                        type="number"
                                        step="any"
                                        value={inputs.D3}
                                        onChange={(e) => handleInputChange('D3', e.target.value)}
                                        onKeyPress={(e) => handleKeyPress(e, 'D3')}
                                        placeholder="e.g., 0.04"
                                    />
                                </div>
                                <div className="input-group">
                                    <label>Roughness (ε₃) [m]</label>
                                    <input
                                        ref={el => inputRefs.current['epsilon3'] = el}
                                        type="number"
                                        step="any"
                                        value={inputs.epsilon3}
                                        onChange={(e) => handleInputChange('epsilon3', e.target.value)}
                                        onKeyPress={(e) => handleKeyPress(e, 'epsilon3')}
                                        placeholder="e.g., 0.00020"
                                    />
                                </div>
                            </div>
                            
                            <div className="form-section">
                                <div className="section-label">Fluid & Convergence</div>
                                <div className="input-group">
                                    <label>Kinematic Viscosity (ν) [m²/s]</label>
                                    <input
                                        ref={el => inputRefs.current['nu'] = el}
                                        type="number"
                                        step="any"
                                        value={inputs.nu}
                                        onChange={(e) => handleInputChange('nu', e.target.value)}
                                        onKeyPress={(e) => handleKeyPress(e, 'nu')}
                                        placeholder="e.g., 1.02e-6"
                                    />
                                </div>
                                <div className="input-group">
                                    <label>Tolerance [%]</label>
                                    <input
                                        ref={el => inputRefs.current['tolerance'] = el}
                                        type="number"
                                        step="any"
                                        value={inputs.tolerance}
                                        onChange={(e) => handleInputChange('tolerance', e.target.value)}
                                        onKeyPress={(e) => handleKeyPress(e, 'tolerance')}
                                        placeholder="e.g., 1.0"
                                    />
                                </div>
                            </div>
                            
                            <button className="calculate-button" onClick={calculate} disabled={calculating}>
                                {calculating ? 'Calculating...' : 'Calculate Junction Head'}
                            </button>
                        </div>
                        
                        <div className="results-panel">
                            <div className="panel-title">Results</div>
                            
                            {results && results.error && (
                                <div className="result-card error">
                                    <div className="result-header error">⚠ Error</div>
                                    <p>{results.message}</p>
                                </div>
                            )}
                            
                            {results && results.success && (
                                <>
                                    <div className="result-card success">
                                        <div className="result-header">✓ Solution Converged!</div>
                                        <div className="result-value">{results.Hj.toFixed(2)} m</div>
                                        <div className="result-label">Junction Head (Hⱼ)</div>
                                    </div>
                                    
                                    <div className="pipe-result">
                                        <div className="pipe-header">
                                            <span>Pipe 1 (Reservoir z={results.pipe1.z}m)</span>
                                            <span className={`flow-direction ${results.pipe1.Q > 0 ? 'inflow' : 'outflow'}`}>
                                                {results.pipe1.Q > 0 ? 'INFLOW' : 'OUTFLOW'}
                                            </span>
                                        </div>
                                        <div className="result-grid">
                                            <div className="result-item">
                                                <div className="result-item-label">Flow Rate</div>
                                                <div className="result-item-value">
                                                    {results.pipe1.Q.toFixed(4)} m³/s<br/>
                                                    ({(results.pipe1.Q * 1000).toFixed(2)} L/s)
                                                </div>
                                            </div>
                                            <div className="result-item">
                                                <div className="result-item-label">Velocity</div>
                                                <div className="result-item-value">{results.pipe1.V.toFixed(2)} m/s</div>
                                            </div>
                                            <div className="result-item">
                                                <div className="result-item-label">Reynolds Number</div>
                                                <div className="result-item-value">{results.pipe1.Re.toLocaleString(undefined, {maximumFractionDigits: 0})}</div>
                                            </div>
                                            <div className="result-item">
                                                <div className="result-item-label">Friction Factor</div>
                                                <div className="result-item-value">{results.pipe1.f.toFixed(4)}</div>
                                            </div>
                                            <div className="result-item">
                                                <div className="result-item-label">Head Loss</div>
                                                <div className="result-item-value">{results.pipe1.hf.toFixed(2)} m</div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div className="pipe-result">
                                        <div className="pipe-header">
                                            <span>Pipe 2 (Reservoir z={results.pipe2.z}m)</span>
                                            <span className={`flow-direction ${results.pipe2.Q > 0 ? 'inflow' : 'outflow'}`}>
                                                {results.pipe2.Q > 0 ? 'INFLOW' : 'OUTFLOW'}
                                            </span>
                                        </div>
                                        <div className="result-grid">
                                            <div className="result-item">
                                                <div className="result-item-label">Flow Rate</div>
                                                <div className="result-item-value">
                                                    {results.pipe2.Q.toFixed(4)} m³/s<br/>
                                                    ({(results.pipe2.Q * 1000).toFixed(2)} L/s)
                                                </div>
                                            </div>
                                            <div className="result-item">
                                                <div className="result-item-label">Velocity</div>
                                                <div className="result-item-value">{results.pipe2.V.toFixed(2)} m/s</div>
                                            </div>
                                            <div className="result-item">
                                                <div className="result-item-label">Reynolds Number</div>
                                                <div className="result-item-value">{results.pipe2.Re.toLocaleString(undefined, {maximumFractionDigits: 0})}</div>
                                            </div>
                                            <div className="result-item">
                                                <div className="result-item-label">Friction Factor</div>
                                                <div className="result-item-value">{results.pipe2.f.toFixed(4)}</div>
                                            </div>
                                            <div className="result-item">
                                                <div className="result-item-label">Head Loss</div>
                                                <div className="result-item-value">{results.pipe2.hf.toFixed(2)} m</div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div className="pipe-result">
                                        <div className="pipe-header">
                                            <span>Pipe 3 (Reservoir z={results.pipe3.z}m)</span>
                                            <span className={`flow-direction ${results.pipe3.Q > 0 ? 'inflow' : 'outflow'}`}>
                                                {results.pipe3.Q > 0 ? 'INFLOW' : 'OUTFLOW'}
                                            </span>
                                        </div>
                                        <div className="result-grid">
                                            <div className="result-item">
                                                <div className="result-item-label">Flow Rate</div>
                                                <div className="result-item-value">
                                                    {results.pipe3.Q.toFixed(4)} m³/s<br/>
                                                    ({(results.pipe3.Q * 1000).toFixed(2)} L/s)
                                                </div>
                                            </div>
                                            <div className="result-item">
                                                <div className="result-item-label">Velocity</div>
                                                <div className="result-item-value">{results.pipe3.V.toFixed(2)} m/s</div>
                                            </div>
                                            <div className="result-item">
                                                <div className="result-item-label">Reynolds Number</div>
                                                <div className="result-item-value">{results.pipe3.Re.toLocaleString(undefined, {maximumFractionDigits: 0})}</div>
                                            </div>
                                            <div className="result-item">
                                                <div className="result-item-label">Friction Factor</div>
                                                <div className="result-item-value">{results.pipe3.f.toFixed(4)}</div>
                                            </div>
                                            <div className="result-item">
                                                <div className="result-item-label">Head Loss</div>
                                                <div className="result-item-value">{results.pipe3.hf.toFixed(2)} m</div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div className="convergence-info">
                                        <div className="convergence-header">Continuity Check</div>
                                        <div className="result-grid">
                                            <div className="result-item">
                                                <div className="result-item-label">Total Inflow</div>
                                                <div className="result-item-value">
                                                    {results.totalInflow.toFixed(4)} m³/s
                                                </div>
                                            </div>
                                            <div className="result-item">
                                                <div className="result-item-label">Total Outflow</div>
                                                <div className="result-item-value">
                                                    {(Math.abs(Math.min(results.pipe1.Q, 0)) + Math.abs(Math.min(results.pipe2.Q, 0)) + Math.abs(Math.min(results.pipe3.Q, 0))).toFixed(4)} m³/s
                                                </div>
                                            </div>
                                            <div className="result-item">
                                                <div className="result-item-label">Net (ΣQ)</div>
                                                <div className="result-item-value">
                                                    {results.sumQ.toFixed(6)} m³/s {results.errorPercent < 0.1 ? '✓' : ''}
                                                </div>
                                            </div>
                                            <div className="result-item">
                                                <div className="result-item-label">Error</div>
                                                <div className="result-item-value">{results.errorPercent.toFixed(2)}%</div>
                                            </div>
                                            <div className="result-item">
                                                <div className="result-item-label">Iterations</div>
                                                <div className="result-item-value">{results.iterations}</div>
                                            </div>
                                        </div>
                                    </div>
                                </>
                            )}
                            
                            {iterationDetails.length > 0 && (
                                <div style={{marginTop: 'calc(var(--grid) * 4)'}}>
                                    <div className="panel-title">Detailed Iteration Steps</div>
                                    
                                    {iterationDetails.map((iter, idx) => (
                                        <div key={idx} className="iteration-section">
                                            <div className="iteration-header">
                                                Iteration {iter.iteration}: H_j = {iter.Hj.toFixed(2)} m
                                            </div>
                                            
                                            {iter.reasoning && (
                                                <div className="reasoning">
                                                    <strong>Reasoning:</strong> {iter.reasoning}
                                                </div>
                                            )}
                                            
                                            {/* Pipe 1 */}
                                            <div className="iteration-step">
                                                <div className="step-title">Pipe 1 (Type II Problem)</div>
                                                <div className="math-block">
                                                    <p><strong>Bernoulli Equation:</strong></p>
                                                    <p>$$H_j - h_{{f,1}} = z_1$$</p>
                                                    <p>$${iter.Hj.toFixed(2)} - h_{{f,1}} = {iter.pipe1.z}$$</p>
                                                    <p>$$h_{{f,1}} = {iter.pipe1.z > iter.Hj ? iter.Hj + ' - ' + iter.pipe1.z : iter.Hj + ' - ' + iter.pipe1.z} = {Math.abs(iter.pipe1.deltaH).toFixed(2)} \text{{ m}}$$</p>
                                                    <p><strong>Darcy-Weisbach:</strong></p>
                                                    <p>$$h_f = f \\frac{{L}}{{D}} \\frac{{V^2}}{{2g}}$$</p>
                                                    <p>$$V = \\sqrt{{\\frac{{2g \\cdot h_f \\cdot D}}{{f \\cdot L}}}} = \\sqrt{{\\frac{{2 \\times 9.81 \\times {Math.abs(iter.pipe1.deltaH).toFixed(2)} \\times {iter.pipe1.D}}}{{f \\times {iter.pipe1.L}}}}}$$</p>
                                                    <p><strong>Initial f (Hydraulically Rough):</strong></p>
                                                    <p>$$f_0 = \\frac{{1.325}}{{\\left[\\ln\\left(\\frac{{\\varepsilon/D}}{{3.7}}\\right)\\right]^2}} = \\frac{{1.325}}{{\\left[\\ln\\left(\\frac{{{iter.pipe1.epsilon}/{iter.pipe1.D}}}{{3.7}}\\right)\\right]^2}} = {iter.pipe1.iterations[0].f.toFixed(4)}$$</p>
                                                </div>
                                                
                                                {iter.pipe1.iterations.length > 0 && (
                                                    <>
                                                        <p style={{margin: 'calc(var(--grid) * 2) 0', color: 'var(--text-muted)'}}>
                                                            <strong>Friction Factor Iteration:</strong>
                                                        </p>
                                                        <table className="iteration-table">
                                                            <thead>
                                                                <tr>
                                                                    <th>Iter</th>
                                                                    <th>f</th>
                                                                    <th>V (m/s)</th>
                                                                    <th>Re</th>
                                                                    <th>ε/D</th>
                                                                    <th>f_new</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody>
                                                                {iter.pipe1.iterations.map((fIter, fIdx) => (
                                                                    <tr key={fIdx}>
                                                                        <td>{fIter.iteration}</td>
                                                                        <td>{fIter.f.toFixed(4)}</td>
                                                                        <td>{fIter.V.toFixed(2)}</td>
                                                                        <td>{fIter.Re.toFixed(0)}</td>
                                                                        <td>{fIter.eOverD.toFixed(5)}</td>
                                                                        <td>{fIter.fNew.toFixed(4)}</td>
                                                                    </tr>
                                                                ))}
                                                            </tbody>
                                                        </table>
                                                    </>
                                                )}
                                                
                                                <div className="math-block">
                                                    <p><strong>Final Calculation:</strong></p>
                                                    <p>$$Q_1 = V \\times A = {iter.pipe1.V.toFixed(2)} \\times \\frac{{\\pi \\times {iter.pipe1.D}^2}}{{4}} = {Math.abs(iter.pipe1.Q).toFixed(4)} \\text{{ m}}^3\\text{{/s}}$$</p>
                                                    <p><strong>Direction:</strong> {iter.pipe1.Q > 0 ? '(+) Inflow to junction' : '(-) Outflow from junction'}</p>
                                                </div>
                                            </div>
                                            
                                            {/* Pipe 2 */}
                                            <div className="iteration-step">
                                                <div className="step-title">Pipe 2 (Type II Problem)</div>
                                                <div className="math-block">
                                                    <p><strong>Bernoulli Equation:</strong></p>
                                                    <p>$$z_2 - h_{{f,2}} = H_j$$</p>
                                                    <p>$${iter.pipe2.z} - h_{{f,2}} = {iter.Hj.toFixed(2)}$$</p>
                                                    <p>$$h_{{f,2}} = {iter.pipe2.deltaH.toFixed(2)} \\text{{ m}}$$</p>
                                                </div>
                                                
                                                {iter.pipe2.iterations.length > 0 && (
                                                    <>
                                                        <p style={{margin: 'calc(var(--grid) * 2) 0', color: 'var(--text-muted)'}}>
                                                            <strong>Friction Factor Iteration:</strong>
                                                        </p>
                                                        <table className="iteration-table">
                                                            <thead>
                                                                <tr>
                                                                    <th>Iter</th>
                                                                    <th>f</th>
                                                                    <th>V (m/s)</th>
                                                                    <th>Re</th>
                                                                    <th>ε/D</th>
                                                                    <th>f_new</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody>
                                                                {iter.pipe2.iterations.map((fIter, fIdx) => (
                                                                    <tr key={fIdx}>
                                                                        <td>{fIter.iteration}</td>
                                                                        <td>{fIter.f.toFixed(4)}</td>
                                                                        <td>{fIter.V.toFixed(2)}</td>
                                                                        <td>{fIter.Re.toFixed(0)}</td>
                                                                        <td>{fIter.eOverD.toFixed(5)}</td>
                                                                        <td>{fIter.fNew.toFixed(4)}</td>
                                                                    </tr>
                                                                ))}
                                                            </tbody>
                                                        </table>
                                                    </>
                                                )}
                                                
                                                <div className="math-block">
                                                    <p><strong>Final:</strong> Q₂ = {iter.pipe2.Q > 0 ? '+' : ''}{iter.pipe2.Q.toFixed(4)} m³/s {iter.pipe2.Q > 0 ? '(inflow)' : '(outflow)'}</p>
                                                </div>
                                            </div>
                                            
                                            {/* Pipe 3 */}
                                            <div className="iteration-step">
                                                <div className="step-title">Pipe 3 (Type II Problem)</div>
                                                <div className="math-block">
                                                    <p><strong>Bernoulli Equation:</strong></p>
                                                    <p>$$z_3 - h_{{f,3}} = H_j$$</p>
                                                    <p>$${iter.pipe3.z} - h_{{f,3}} = {iter.Hj.toFixed(2)}$$</p>
                                                    <p>$$h_{{f,3}} = {iter.pipe3.deltaH.toFixed(2)} \\text{{ m}}$$</p>
                                                </div>
                                                
                                                {iter.pipe3.iterations.length > 0 && iter.pipe3.iterations.length < 15 && (
                                                    <>
                                                        <p style={{margin: 'calc(var(--grid) * 2) 0', color: 'var(--text-muted)'}}>
                                                            <strong>Friction Factor Iteration:</strong>
                                                        </p>
                                                        <table className="iteration-table">
                                                            <thead>
                                                                <tr>
                                                                    <th>Iter</th>
                                                                    <th>f</th>
                                                                    <th>V (m/s)</th>
                                                                    <th>Re</th>
                                                                    <th>ε/D</th>
                                                                    <th>f_new</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody>
                                                                {iter.pipe3.iterations.map((fIter, fIdx) => (
                                                                    <tr key={fIdx}>
                                                                        <td>{fIter.iteration}</td>
                                                                        <td>{fIter.f.toFixed(4)}</td>
                                                                        <td>{fIter.V.toFixed(2)}</td>
                                                                        <td>{fIter.Re.toFixed(0)}</td>
                                                                        <td>{fIter.eOverD.toFixed(5)}</td>
                                                                        <td>{fIter.fNew.toFixed(4)}</td>
                                                                    </tr>
                                                                ))}
                                                            </tbody>
                                                        </table>
                                                    </>
                                                )}
                                                
                                                <div className="math-block">
                                                    <p><strong>Final:</strong> Q₃ = {iter.pipe3.Q > 0 ? '+' : ''}{iter.pipe3.Q.toFixed(4)} m³/s {iter.pipe3.Q > 0 ? '(inflow)' : '(outflow)'}</p>
                                                </div>
                                            </div>
                                            
                                            {/* Continuity Check */}
                                            <div className="iteration-step">
                                                <div className="step-title">Continuity at Junction</div>
                                                <div className="math-block">
                                                    <p>$$\\sum Q = Q_1 + Q_2 + Q_3$$</p>
                                                    <p>$$\\sum Q = {iter.pipe1.Q > 0 ? '+' : ''}{iter.pipe1.Q.toFixed(4)} + {iter.pipe2.Q > 0 ? '+' : ''}{iter.pipe2.Q.toFixed(4)} + {iter.pipe3.Q > 0 ? '+' : ''}{iter.pipe3.Q.toFixed(4)}$$</p>
                                                    <p>$$\\sum Q = {iter.sumQ.toFixed(4)} \\text{{ m}}^3\\text{{/s}}$$</p>
                                                    <p><strong>Error:</strong> {iter.errorPercent.toFixed(2)}%</p>
                                                    {iter.errorPercent < parseFloat(inputs.tolerance) ? (
                                                        <p style={{color: 'var(--success)', fontWeight: 'bold'}}>✓ Converged! (Error &lt; {inputs.tolerance}%)</p>
                                                    ) : (
                                                        <p style={{color: 'var(--accent)'}}>
                                                            {iter.sumQ > 0 ? '→ Influx > Outflux (H_j too low)' : '→ Outflux > Influx (H_j too high)'}
                                                        </p>
                                                    )}
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            )}
                            
                            {!results && !calculating && (
                                <div style={{color: 'var(--text-muted)', textAlign: 'center', padding: 'calc(var(--grid) * 8)'}}>
                                    Enter parameters and click Calculate to see results
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        }
        
        ReactDOM.render(<JunctionHeadCalculator />, document.getElementById('root'));
    </script>
</body>
</html>
